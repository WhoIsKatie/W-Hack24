<!DOCTYPE html>
<html>
<head>
    <title>Email Frontend</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@latest/dist/tailwind.min.css" rel="stylesheet">
</head>
<style>
    .container {
        display: flex;
        height: 100vh;
    }

    .email-list {
        flex: 0 0 20%;
        background-color: #dedede;
        padding: 5px;
    }

    hr {
        margin: 0;
    }

    .email-list-item {
        {#margin-bottom: 5px;#}
        padding: 5px;
        background-color: #f5f5f5;
        cursor: pointer;
    }

    .email-list-item:hover {
        background-color: #eaeaea;
    }

    .email-viewer {
        flex: 1;
        padding: 20px;
    }

    .alert {
        position: fixed;
        top: 0;
        right: 0;
        visibility: hidden;
    }
</style>
<script>
    console.log("js loaded")
    var selected = NaN;

    document.addEventListener("DOMContentLoaded", function () {
        // Get the outer div element
        var emailList = document.getElementById("email_list");
        var bodyArrayList = {{ body_array|tojson }};
        var spinner = document.getElementById("spinner");

        spinner.style.display = "none";

        emailList.addEventListener("click", function (event) {
            if (event.target.classList.contains("email-list-item")) {
                var clickedEmail = event.target;
                var emailContentLocation = document.getElementById("email-content")

                var emailContent = bodyArrayList[clickedEmail.id.split("_")[1]].replace(/'/g, "\\'");

                emailContentLocation.innerHTML = emailContent;

                spinner.style.display = "inline-flex";

                if (selected !== clickedEmail.id.split("_")[1]) {
                {#if (emailContentLocation.innerHTML !== emailContent) {#}
                    spinner.getElementsByTagName("svg")[0].style.display = "block";
                    spinner.getElementsByTagName("p")[0].innerText = "Processing...";
                    spinner.style.backgroundColor = "#6065e8";
                }
                selected = clickedEmail.id.split("_")[1];
                fetch('/ping', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({email: emailContent})
                })
                    .then(response => response.json())
                    .then(data => {
                        let message = data["message"];
                        spinner.getElementsByTagName("svg")[0].style.display = "none";


                        if (message === "Spam") {
                            spinner.getElementsByTagName("p")[0].innerText = "Spam";
                            spinner.style.backgroundColor = "red";
                        } else {
                            spinner.style.backgroundColor = "green";
                        }
                        spinner.getElementsByTagName("p")[0].innerText = data["message"];

                        console.log(data);
                    })
                    .catch(error => {
                        console.error('Error: ' + error);
                    });
            }
        });
    });
</script>
<body>
{#<img class="alert" src="app/alert.png" alt="">#}
<div class="flex container">
    <div class="email-list w-1/3" id="email_list">
        {% for email in email_list %}
            <div class="email-list-item" id="email_{{ loop.index0 }}">{{ email }}</div>
            <hr>
        {% endfor %}
    </div>
    <div class="email-viewer w-2/3">
        <h2>Email Viewer</h2>
        <div id="spinner"
                class="inline-flex items-center px-4 py-2 mx-1 my-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-indigo-500 transition ease-in-out duration-150"
                >
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
                 viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p>Processing...</p>
        </div>

        <p id="email-content">Click on an email to view its content.</p>
    </div>
</div>
<script>
    function displayEmailContent(content) {
        document.getElementById("email-content").innerText = content;
    }
</script>
</body>
</html>